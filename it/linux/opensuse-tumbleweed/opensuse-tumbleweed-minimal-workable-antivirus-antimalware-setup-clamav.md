# openSUSE Tumbleweed — Minimal, Workable Antivirus/Antimalware Setup (ClamAV)

## 1. Objective and Scope

This document provides a minimal, operational antivirus/antimalware configuration for an openSUSE Tumbleweed notebook using **ClamAV** (authorized, free). The setup is designed to:

* Keep malware signatures current automatically.
* Provide **on-demand** scanning for high-risk locations (e.g., Downloads).
* Provide **scheduled** scanning (weekly) with minimal overhead.
* Optionally provide **real-time (on-access)** scanning for a narrow directory scope (recommended: Downloads only).

ClamAV is most effective at detecting **known** malware signatures, especially in files exchanged with Windows/macOS ecosystems. It is not a full EDR replacement.

---

## 2. Installation

### 2.1 Install packages

Start with the minimal package set. On Tumbleweed, packages may be split; install what you need explicitly:

```bash
sudo zypper refresh
sudo zypper install clamav clamav-freshclam clamav-daemon
```

If `clamav-freshclam` or `clamav-daemon` are not found on your system, install just `clamav` first and then search:

```bash
sudo zypper install clamav
zypper search -s clamav
```

Install the matching “freshclam” and “daemon” packages shown by the search results.

---

## 3. Signature Updates (Required)

ClamAV is only useful if signatures are updated continuously.

### 3.1 Initialize signature database (first run)

```bash
sudo systemctl start freshclam
```

### 3.2 Enable automatic updates (timer)

```bash
sudo systemctl enable --now freshclam.timer
```

### 3.3 Verify update status

```bash
systemctl status freshclam.timer
journalctl -u freshclam --no-pager -n 50
```

---

## 4. On-Demand Scanning (Recommended Baseline)

### 4.1 Quick scan: Downloads

```bash
clamscan --recursive=yes --infected --bell ~/Downloads
```

### 4.2 Scan with logging

Create a local log directory:

```bash
mkdir -p ~/.local/state/clamav
```

Run:

```bash
clamscan --recursive=yes --infected \
  --log="$HOME/.local/state/clamav/manual-scan.log" \
  "$HOME/Downloads"
```

### 4.3 Notes on common flags

* `--infected` shows only infected matches (less noise).
* `--recursive=yes` scans subdirectories.
* `--bell` produces an audible alert (optional).
* For large archives, scanning can be slower. Keep scope narrow for a notebook.

---

## 5. Scheduled Scanning (Minimal “Set-and-Forget”)

This uses a **systemd user timer** to scan your high-risk folders weekly.

### 5.1 Create user service

```bash
mkdir -p ~/.config/systemd/user ~/.local/state/clamav
```

Create:

`~/.config/systemd/user/clamav-weekly-scan.service`

```ini
[Unit]
Description=Weekly ClamAV scan (Downloads/Desktop)

[Service]
Type=oneshot
ExecStart=/usr/bin/clamscan --recursive=yes --infected \
  --log=%h/.local/state/clamav/weekly-scan.log \
  %h/Downloads %h/Desktop
```

### 5.2 Create user timer

`~/.config/systemd/user/clamav-weekly-scan.timer`

```ini
[Unit]
Description=Run weekly ClamAV scan

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
```

### 5.3 Enable and verify

```bash
systemctl --user daemon-reload
systemctl --user enable --now clamav-weekly-scan.timer
systemctl --user list-timers --all | grep clamav
```

### 5.4 Review results

```bash
tail -n 200 ~/.local/state/clamav/weekly-scan.log
```

---

## 6. Optional: Real-Time (On-Access) Scanning for Downloads Only

This is the minimal real-time approach: on-access scanning restricted to **Downloads** to avoid performance and stability risks.

### 6.1 Enable and start the ClamAV daemon (clamd)

```bash
sudo systemctl enable --now clamd
systemctl status clamd --no-pager
```

If `clamd` is not a known unit, list available clam services:

```bash
systemctl list-unit-files | grep -i clam
```

Enable the unit you have (commonly `clamd` or `clamav-daemon`).

### 6.2 Confirm fanotify support (recommended check)

```bash
grep FANOTIFY /boot/config-$(uname -r)
```

You want to see fanotify enabled in the kernel config.

### 6.3 Configure clamd for on-access scanning

Open the clamd config (commonly one of these paths on openSUSE):

* `/etc/clamd.conf`
* `/etc/clamav/clamd.conf`

Find it:

```bash
rpm -ql clamav-daemon | grep clamd.conf
```

Edit the file and ensure **a narrow include path** is configured (example uses your username):

```conf
# On-access scanning: restrict scope (do not use /)
OnAccessIncludePath /home/YOURUSER/Downloads

# Avoid scanning ClamAV’s own user/process
OnAccessExcludeUname clamav

# Prevention mode blocks access when detection is confident
OnAccessPrevention yes

# Reduce self-referential scanning / deadlock risk
OnAccessDisableDDD yes
```

After changes:

```bash
sudo systemctl restart clamd
```

### 6.4 Start clamonacc (foreground test)

Run this once to confirm correct behavior before making it persistent:

```bash
sudo mkdir -p /var/log/clamav
sudo clamonacc --foreground --log=/var/log/clamav/onaccess.log
```

While `clamonacc` is running, download/test a file into `~/Downloads` to confirm detection triggers as expected (see Section 7).

Stop foreground mode with `Ctrl+C` once validated.

### 6.5 Make clamonacc persistent (systemd service)

Create:

`/etc/systemd/system/clamonacc.service`

```ini
[Unit]
Description=ClamAV On-Access Scanner (clamonacc)
After=network-online.target clamd.service
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/clamonacc --log=/var/log/clamav/onaccess.log
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

Enable:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now clamonacc
systemctl status clamonacc --no-pager
```

---

## 7. Verification (Recommended)

### 7.1 Verify signatures are current

```bash
freshclam --version
sudo freshclam -v
```

### 7.2 EICAR test file

The EICAR test file is a standard harmless test string used to validate AV detection.

```bash
cd ~/Downloads
curl -LO https://secure.eicar.org/eicar.com
```

Expected outcomes:

* **On-demand scan** should detect it:

  ```bash
  clamscan --infected eicar.com
  ```
* If **on-access** is enabled with prevention, attempts to open/read may be blocked or immediately flagged (behavior depends on fanotify mode and config).

Remove the test file afterward:

```bash
rm -f ~/Downloads/eicar.com
```

---

## 8. Operational Guidance (Notebook-Oriented)

### 8.1 Recommended minimal posture

1. **Always** run `freshclam.timer` (automatic signature updates).
2. Weekly scan of:

   * `~/Downloads`
   * `~/Desktop`
3. Add on-access scanning only if you frequently open untrusted files—**and only for `~/Downloads`**.

### 8.2 Exclusions and performance

If scanning becomes slow:

* Keep scans limited to high-risk folders.
* Avoid scanning system directories.
* Avoid scanning large VM images or build caches unless necessary.

### 8.3 Logs

* Scheduled scan log:

  * `~/.local/state/clamav/weekly-scan.log`
* Manual scan log (if used):

  * `~/.local/state/clamav/manual-scan.log`
* On-access log:

  * `/var/log/clamav/onaccess.log`
* Service logs:

  * `journalctl -u clamd -n 200 --no-pager`
  * `journalctl -u clamonacc -n 200 --no-pager`

---

## 9. Troubleshooting

### 9.1 “Unit freshclam.timer not found”

Install the freshclam package (names vary):

```bash
sudo zypper install clamav-freshclam
systemctl list-unit-files | grep -i freshclam
```

Enable the unit name that exists.

### 9.2 “clamd not found” / daemon service name differs

List clam-related services:

```bash
systemctl list-unit-files | grep -i clam
```

Enable the appropriate daemon unit (often `clamd`).

### 9.3 On-access scanning not triggering

* Confirm `clamd` is running.
* Confirm `clamonacc` is running.
* Confirm `OnAccessIncludePath` points to an existing directory.
* Confirm kernel fanotify support (`grep FANOTIFY ...`).
* Check logs:

  ```bash
  sudo tail -n 200 /var/log/clamav/onaccess.log
  sudo journalctl -u clamd -n 200 --no-pager
  sudo journalctl -u clamonacc -n 200 --no-pager
  ```

### 9.4 If you see stability/performance issues

Disable on-access and keep only scheduled/on-demand scanning:

```bash
sudo systemctl disable --now clamonacc
```

---

## 10. Uninstall / Rollback

To remove ClamAV (and stop services first):

```bash
sudo systemctl disable --now clamonacc 2>/dev/null || true
sudo systemctl disable --now clamd 2>/dev/null || true
sudo systemctl disable --now freshclam.timer 2>/dev/null || true

sudo zypper rm clamav clamav-daemon clamav-freshclam
```

Remove user timer files if created:

```bash
systemctl --user disable --now clamav-weekly-scan.timer 2>/dev/null || true
rm -f ~/.config/systemd/user/clamav-weekly-scan.service
rm -f ~/.config/systemd/user/clamav-weekly-scan.timer
systemctl --user daemon-reload
```

---

## 11. Minimal Checklist

* [ ] `sudo zypper install clamav clamav-freshclam clamav-daemon`
* [ ] `sudo systemctl enable --now freshclam.timer`
* [ ] Weekly user timer scans `~/Downloads` and `~/Desktop`
* [ ] (Optional) `sudo systemctl enable --now clamd`
* [ ] (Optional) Configure **on-access** only for `~/Downloads`
* [ ] (Optional) Enable `clamonacc` service after foreground testing
* [ ] Validate with EICAR and review logs
